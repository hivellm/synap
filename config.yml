# ============================================================================
# Synap Server Configuration
# ============================================================================
# High-Performance In-Memory Key-Value Store & Message Broker
# Similar to redis.conf pattern with modern YAML structure
# ============================================================================

# ----------------------------------------------------------------------------
# Network Configuration
# ----------------------------------------------------------------------------
server:
  # Bind address - listen on all interfaces by default
  # Examples:
  #   "127.0.0.1"  -> localhost only
  #   "0.0.0.0"    -> all interfaces (default)
  host: "0.0.0.0"
  
  # HTTP API port
  port: 15500
  
  # Enable WebSocket support for real-time subscriptions
  websocket_enabled: false

# ----------------------------------------------------------------------------
# Memory Management
# ----------------------------------------------------------------------------
kv_store:
  # Maximum memory usage in MB
  # When limit is reached, keys are evicted based on policy
  # Common values: 256 (small), 1024 (medium), 4096 (large), 8192 (very large)
  max_memory_mb: 4096
  
  # Eviction policy when memory limit is reached
  # Options:
  #   lru  -> Least Recently Used (recommended for cache)
  #   lfu  -> Least Frequently Used
  #   ttl  -> Shortest Time-To-Live first
  #   none -> No eviction (returns errors on write)
  eviction_policy: "lru"
  
  # TTL cleanup interval in milliseconds
  # Lower = faster cleanup, higher CPU usage
  # Higher = slower cleanup, lower CPU usage
  ttl_cleanup_interval_ms: 100
  
  # Allow dangerous commands (FLUSHDB, FLUSHALL)
  # WARNING: Disabled by default to prevent accidental data loss
  # Enable only in development/testing environments
  allow_flush_commands: false

# ----------------------------------------------------------------------------
# Queue System
# ----------------------------------------------------------------------------
queue:
  # Enable queue system
  enabled: true
  
  # Maximum messages per queue
  # When limit is reached, new publishes will fail
  max_depth: 100000
  
  # ACK deadline in seconds
  # Unacknowledged messages are requeued after this time
  ack_deadline_secs: 30
  
  # Default maximum retry attempts before moving to DLQ
  default_max_retries: 3
  
  # Default message priority (0-9, where 9 is highest)
  default_priority: 5

# ----------------------------------------------------------------------------
# Authentication & Security
# ----------------------------------------------------------------------------
auth:
  # Enable authentication system
  # IMPORTANT: Required when binding to 0.0.0.0 in production
  enabled: false
  
  # Require authentication for all endpoints
  # If false, anonymous access is allowed (with limited permissions)
  require_auth: false
  
  # Root user configuration (created on first startup)
  # CHANGE THESE IN PRODUCTION!
  root:
    username: "root"
    password: "root"  # MUST be changed in production!
    enabled: true
  
  # Default TTL for temporary API keys (in seconds)
  default_key_ttl: 3600

# Access Control Lists (ACL)
# Define resource-level permissions
acl:
  # Enable ACL enforcement
  enabled: false
  
  # Default rules (examples)
  rules:
    # Public queue (no auth required)
    - resource: "queue:public"
      require_auth: false
      actions: ["read", "write"]
    
    # Protected queue (auth required)
    - resource: "queue:private"
      require_auth: true
      actions: ["read", "write"]
      allowed_users: []
      allowed_roles: ["admin", "queue_user"]
    
    # Admin-only queue
    - resource: "queue:admin"
      require_auth: true
      actions: ["all"]
      allowed_roles: ["admin"]
    
    # KV Store (read-only for authenticated users)
    - resource: "kv:*"
      require_auth: true
      actions: ["read"]
      allowed_users: []
    
    # KV Store write (admin only)
    - resource: "kv:*"
      require_auth: true
      actions: ["write", "delete"]
      allowed_roles: ["admin"]

# ----------------------------------------------------------------------------
# Rate Limiting
# ----------------------------------------------------------------------------
rate_limit:
  # Enable rate limiting (token bucket algorithm)
  # Protects against DoS attacks and excessive API usage
  enabled: false
  
  # Maximum requests per second per IP
  # Recommended: 100-1000 (public), 10000+ (internal)
  requests_per_second: 1000
  
  # Burst size (maximum tokens in bucket)
  # Allows temporary spikes above rate limit
  # Should be >= requests_per_second for smooth traffic
  burst_size: 100

# ----------------------------------------------------------------------------
# Logging
# ----------------------------------------------------------------------------
logging:
  # Log verbosity level
  # Options: trace, debug, info, warn, error
  level: "info"
  
  # Log format
  # Options:
  #   json   -> Machine-readable structured logs (production)
  #   pretty -> Human-readable colored output (development)
  format: "json"

# ----------------------------------------------------------------------------
# Protocols
# ----------------------------------------------------------------------------
protocols:
  # StreamableHTTP Protocol
  # Modern HTTP-based protocol with command routing and streaming
  streamable_http:
    enabled: true
    path: "/api/v1/command"
  
  # REST API
  # Traditional REST endpoints for simple HTTP clients
  rest:
    enabled: true
    prefix: "/kv"

# ----------------------------------------------------------------------------
# MCP (Model Context Protocol) Tools
# ----------------------------------------------------------------------------
# Configure which MCP tool categories to expose
# Note: Cursor has limits on the number of MCP tools it can handle efficiently
# Default: Only essential tools (KV + Queue = 4 tools total)
# Maximum: All categories enabled = 16 tools

mcp:
  # KV Tools (3 tools): synap_kv_get, synap_kv_set, synap_kv_delete
  # Essential - recommended to keep enabled
  enable_kv_tools: true
  
  # Hash Tools (3 tools): synap_hash_get, synap_hash_set, synap_hash_getall
  enable_hash_tools: false
  
  # List Tools (3 tools): synap_list_push, synap_list_pop, synap_list_range
  enable_list_tools: false
  
  # Set Tools (3 tools): synap_set_add, synap_set_members, synap_set_inter
  enable_set_tools: false
  
  # Queue Tools (1 tool): synap_queue_publish
  # Essential - recommended to keep enabled
  enable_queue_tools: true
  
  # Sorted Set Tools (3 tools): synap_sortedset_zadd, synap_sortedset_zrange, synap_sortedset_zrank
  enable_sortedset_tools: false

# Note: All functionality is available via REST API and StreamableHTTP
# regardless of MCP tool configuration

# ----------------------------------------------------------------------------
# Replication
# ----------------------------------------------------------------------------
# Master-Slave replication for high availability and read scaling
# - 1 write master node + N read-only replica nodes
# - TCP binary protocol with length-prefixed framing
# - Full sync via snapshot transfer (CRC32 verified)
# - Partial sync via replication log (incremental updates)
# - Auto-reconnect with intelligent resync

replication:
  # Enable replication
  enabled: false
  
  # Node role
  # Options:
  #   master     -> Accepts writes, replicates to replicas
  #   replica    -> Read-only, syncs from master
  #   standalone -> No replication (single node)
  role: "standalone"
  
  # Master configuration (only used when role = "master")
  # replica_listen_address: "0.0.0.0:15501"
  
  # Replica configuration (only used when role = "replica")
  # master_address: "127.0.0.1:15501"
  
  # Performance tuning
  heartbeat_interval_ms: 1000      # Heartbeat interval (ms)
  max_lag_ms: 10000                # Maximum replication lag threshold (ms)
  buffer_size_kb: 256              # Replication buffer size (KB)
  auto_reconnect: true             # Auto-reconnect on disconnect
  reconnect_delay_ms: 5000         # Reconnect delay (ms)
  replica_timeout_secs: 30         # Replica timeout (seconds)

# ----------------------------------------------------------------------------
# Persistence
# ----------------------------------------------------------------------------
# Optional persistence using Write-Ahead Log and Snapshots

persistence:
  # Enable data durability
  enabled: true
  
  # Write-Ahead Log (WAL) settings
  wal:
    enabled: true
    path: "./data/wal/synap.wal"
    buffer_size_kb: 64
    fsync_mode: "always"            # Options: always, periodic, never
    fsync_interval_ms: 1000
    max_size_mb: 1024
  
  # Snapshot settings
  snapshot:
    enabled: true
    directory: "./data/snapshots"
    interval_secs: 300              # Snapshot every 5 minutes
    operation_threshold: 10000      # Or every 10K operations
    max_snapshots: 10               # Keep last 10 snapshots
    compression: false              # Not yet implemented
